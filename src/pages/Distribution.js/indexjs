import React, { useEffect, useRef, useState } from "react";
import { Button, Card, Container, Jumbotron } from "react-bootstrap";
/* global google */
import firebase from "../../services/firebaseConfig";
import {
  getRouteData,
  isRouteCreated,
  setDriverMealList,
  getDriverMealList,
  setIsRouteCreated,
  setRouteData,
  setMealDeliveryData,
  getMealDeliveryData,
  setDeliveryMealType,
  getDeliveryMealType,
} from "../../utilities/storage";
import { SiGooglemaps } from "react-icons/si";
import { HiPhone } from "react-icons/hi";
import styled from "styled-components";

const Distribution = () => {
  const [mealData, setMealData] = useState([]);
  const [mealBestData, setMealBestData] = useState([]);
  const [savedMealList, setsavedMealList] = useState(getMealDeliveryData());
  const [routeData, setrouteData] = useState(null);
  const [isRouteAvailable, setisRouteAvailable] = useState(isRouteCreated());
  const [routeSelectionState, setrouteSelectionState] = useState("route");
  const [bestRouteData, setbestRouteData] = useState(getRouteData());
  const [totalDistance, settotalDistance] = useState("");
  const [totalStops, settotalStops] = useState(0);
  const refMap = useRef(null);

  useEffect(() => {
    console.log(getMealDeliveryData());
    console.log(getDriverMealList());
    console.log(bestRouteData);
    if (isRouteAvailable) {
      ShowMealList();
      ShowMap();
      console.log(window.H);
    }
  }, []);

  const RoutesDataApi = () => {
    const db = firebase.firestore();
    db.collection("routes")
      .doc("route")
      .get()
      .then((result) => {
        if (result.data()) {
          console.log(result.data());
          setrouteData(result.data());
          setrouteSelectionState("driver");
          //   if (result.data().driver_1.length > 0) {
          //     let temp = [];
          //     result.data().driver_1.forEach((val) => {
          //       val.get().then((result) => {
          //         temp.push(result.data());
          //       });
          //       setMealData(temp);
          //     });
          //   }
        }
      })
      .catch((error) => {
        console.log("error ", error.message);
      });
  };

  const MealDataApi = (driver) => {
    setDriverMealList(routeData[driver]);
    setDeliveryMealType(routeData.meal_type);

    var promise = [];
    routeData[driver].forEach((element) => {
      promise.push(
        new Promise((resolve, reject) => {
          firebase
            .firestore()
            .collection("mealRequests")
            .doc(element)
            .get()
            .then((result) => {
              if (result.data()) {
                var data = {
                  ...result.data(),
                  id: result.id,
                };
                resolve(data);
              }
            });
        })
      );
    });
    Promise.all(promise).then(
      (result) => {
        setMealData(result);
        setMealDeliveryData(result);
        setsavedMealList(result);
      },
      () => {}
    );
    setrouteSelectionState("best");
  };

  const MealDataRefreshApi = () => {
    var promise = [];
    getDriverMealList().forEach((element) => {
      promise.push(
        new Promise((resolve, reject) => {
          firebase
            .firestore()
            .collection("mealRequests")
            .doc(element)
            .get()
            .then((result) => {
              if (result.data()) {
                var data = {
                  ...result.data(),
                  id: result.id,
                };
                resolve(data);
              }
            });
        })
      );
    });
    Promise.all(promise).then(
      (result) => {
        setMealDeliveryData(result);
        setsavedMealList(result);
        ShowMealList();
      },
      () => {}
    );
    setrouteSelectionState("best");
  };

  const BestRoute = () => {
    const directionsService = new google.maps.DirectionsService();

    const waypts = [];
    mealData.forEach((data) => {
      waypts.push({
        location: { lat: data.geopoint.lat, lng: data.geopoint.lng },
        stopover: true,
      });
    });

    directionsService.route(
      {
        origin: { lat: 28.440917, lng: 77.062629 },
        destination: { lat: 28.440917, lng: 77.062629 },
        waypoints: waypts,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING,
        provideRouteAlternatives: false,
      },
      (response, status) => {
        if (status === "OK" && response) {
          console.log(response);
          setbestRouteData(response);
          setisRouteAvailable(true);
          setIsRouteCreated(true);
          setRouteData(response);
          ShowMap();
          ShowMealList();
        } else {
          console.log("Directions request failed due to " + status);
        }
      }
    );
  };

  const ShowMap = () => {
    const directionsRenderer = new google.maps.DirectionsRenderer({
      polylineOptions: {
        strokeColor: "#469623",
      },
    });
    const options = {
      streetViewControl: false,
      mapId: "b4847045d4f3260e",
      restriction: {
        latLngBounds: {
          north: 28.5,
          south: 28.381183,
          west: 76.99,
          east: 77.1,
        },
        strictBounds: false,
      },
      gestureHandling: "greedy",
      mapTypeControl: false,
    };
    const map = new google.maps.Map(refMap.current, options);
    directionsRenderer.setMap(map);
    directionsRenderer.setDirections(getRouteData());
  };

  const ShowMealList = () => {
    if (getMealDeliveryData() && getRouteData()) {
      var promise = [];
      let distance = 0;
      getRouteData().routes[0].legs.forEach((val) => {
        distance += val.distance.value;
      });
      settotalDistance(`${distance / 1000} km`);
      settotalStops(getRouteData().routes[0].legs.length - 1);
      getRouteData().routes[0].waypoint_order.forEach((val) => {
        promise.push(getMealDeliveryData()[val]);
      });

      setMealBestData(promise);
    }
  };

  const DriverBtnList = () => {
    return Array.from({ length: routeData.total_driver }, (item, index) => (
      <Button
        style={{ margin: 12 }}
        onClick={() => {
          MealDataApi(`driver_${index + 1}`);
        }}
        variant="success"
        key={index}
      >
        {`driver ${index + 1}`}
      </Button>
    ));
  };

  const MealCard = ({ item }) => {
    var meal = "";
    if (item.lunch) meal = "Lunch  - " + item.quantityLunch;
    if (item.dinner) meal = "Dinner  - " + item.quantityDinner;
    if (item.lunch && item.dinner)
      meal =
        "Lunch - " + item.quantityLunch + " & Dinner - " + item.quantityDinner;

    const timeStampDate = item.timestamp;
    const dateInMillis = timeStampDate.seconds * 1000;
    var date =
      new Date(dateInMillis).toDateString() +
      " at " +
      new Date(dateInMillis).toLocaleTimeString();

    return (
      <Card
        style={{
          margin: 6,
          marginBottom: 16,
          borderRadius: 4,
          boxShadow: "1px 1px 1px 1px black",
          background: "#1f2223",
          color: "white",
          cursor: "pointer",
        }}
      >
        <Card.Body>
          <Card.Title>{item.name}</Card.Title>
          {item.address ? (
            <Card.Subtitle className="mb-2 text-muted">
              {item.address}
            </Card.Subtitle>
          ) : null}
          <Card.Text>{meal}</Card.Text>
          {item.timestamp ? (
            <Card.Subtitle className="mb-2 text-muted">{date}</Card.Subtitle>
          ) : null}
        </Card.Body>
      </Card>
    );
  };

  const setDelivered = (id) => {
    var data = {};
    if (getDeliveryMealType() === "lunch") data = { delivered_lunch: true };
    if (getDeliveryMealType() === "dinner") data = { delivered_dinner: true };
    const db = firebase.firestore();
    db.collection("mealRequests")
      .doc(id)
      .set(data, { merge: true })
      .then((result) => {
        MealDataRefreshApi();
      })
      .catch((error) => {
        console.log("error ", error.message);
      });
  };

  const setOnWay = (id, geopoint) => {
    var data = {};
    var mapLink = "/" + geopoint.lat + "," + geopoint.lng;
    if (getDeliveryMealType() === "lunch") data = { onway_lunch: true };
    if (getDeliveryMealType() === "dinner") data = { onway_dinner: true };
    const db = firebase.firestore();
    db.collection("mealRequests")
      .doc(id)
      .set(data, { merge: true })
      .then((result) => {
        window.open(
          `https://www.google.com/maps/dir/Current+Location${mapLink}`
        );
      })
      .catch((error) => {
        window.open(
          `https://www.google.com/maps/dir/Current+Location${mapLink}`
        );
        console.log("error ", error.message);
      });
  };

  const MealRouteCard = ({ item }) => {
    if (getDeliveryMealType() === "lunch" && item.delivered_lunch) return null;
    if (getDeliveryMealType() === "dinner" && item.delivered_dinner)
      return null;

    var meal = "";
    if (getDeliveryMealType() === "lunch")
      meal = "Lunch  - " + item.quantityLunch;
    if (getDeliveryMealType() === "dinner")
      meal = "Dinner  - " + item.quantityDinner;

    return (
      <Card
        style={{
          borderRadius: 4,
          boxShadow: "1px 1px 1px 1px black",
          background: "#1f2223",
          color: "white",
        }}
      >
        <Card.Body>
          <Card.Title>{item.name}</Card.Title>

          {item.address ? (
            <div
              style={{
                display: "flex",
                flexDirection: "row",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: 6,
              }}
            >
              <div style={{ width: "88%" }}>
                <div
                  style={{
                    color: "#a0a0a0",
                    fontSize: "0.9rem",
                  }}
                >
                  Address
                </div>
                <div
                  style={{
                    color: "#fff",
                    marginBottom: 4,
                    fontSize: "1rem",
                  }}
                >
                  {item.address}
                </div>
              </div>
              <div
                onClick={() => {
                  window.open("https://maps.google.com?q=" + item.address);
                }}
                style={{
                  width: "2rem",
                  height: "2rem",
                  borderRadius: 30,
                  background: "#2b4723",
                  color: "#afe84f",
                  display: "flex",
                  justifyContent: "center",
                  alignItems: "center",
                  fontSize: "1rem",
                }}
              >
                <SiGooglemaps />
              </div>
            </div>
          ) : null}

          {item.address_detail ? (
            <div
              style={{
                display: "flex",
                flexDirection: "row",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: 6,
              }}
            >
              <div style={{ width: "88%" }}>
                <div
                  style={{
                    color: "#a0a0a0",
                    fontSize: "0.9rem",
                  }}
                >
                  Address Detail
                </div>
                <div
                  style={{
                    color: "#fff",
                    marginBottom: 4,
                    fontSize: "1rem",
                  }}
                >
                  {item.address_detail}
                </div>
              </div>
            </div>
          ) : null}

          {item.phone ? (
            <div
              style={{
                display: "flex",
                flexDirection: "row",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: 6,
              }}
            >
              <div style={{ width: "88%" }}>
                <div
                  style={{
                    color: "#a0a0a0",
                    fontSize: "0.9rem",
                  }}
                >
                  Phone
                </div>
                <div
                  style={{
                    color: "#fff",
                    marginBottom: 4,
                    fontSize: "1rem",
                  }}
                >
                  {item.phone}
                </div>
              </div>
              <a
                href={`tel:${item.phone}`}
                style={{
                  width: "2rem",
                  height: "2rem",
                  borderRadius: 30,
                  background: "#2b4723",
                  color: "#afe84f",
                  display: "flex",
                  justifyContent: "center",
                  alignItems: "center",
                  fontSize: "1rem",
                }}
              >
                <HiPhone />
              </a>
            </div>
          ) : null}

          <div
            style={{
              display: "flex",
              flexDirection: "row",
              justifyContent: "space-between",
              alignItems: "center",
              marginBottom: 6,
            }}
          >
            <div style={{ width: "88%" }}>
              <div
                style={{
                  color: "#a0a0a0",
                  fontSize: "0.9rem",
                }}
              >
                Meal Required
              </div>
              <div
                style={{
                  color: "#fff",
                  marginBottom: 4,
                  fontSize: "1rem",
                }}
              >
                {meal}
              </div>
            </div>
          </div>

          {item.remark ? (
            <div
              style={{
                display: "flex",
                flexDirection: "row",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: 6,
              }}
            >
              <div style={{ width: "88%" }}>
                <div
                  style={{
                    color: "#a0a0a0",
                    fontSize: "0.9rem",
                  }}
                >
                  Remark
                </div>
                <div
                  style={{
                    color: "#fff",
                    marginBottom: 4,
                    fontSize: "1rem",
                  }}
                >
                  {item.remark}
                </div>
              </div>
            </div>
          ) : null}
        </Card.Body>
        {getDeliveryMealType() === "lunch" ? (
          <ButtonGroubCont>
            {!item.delivered_lunch ? (
              <ButtonStyled
                onClick={() => setDelivered(item.id)}
                variant="success"
              >
                Delivered
              </ButtonStyled>
            ) : null}
            {!item.onway_lunch && !item.delivered_lunch ? (
              <ButtonStyled
                onClick={() => setOnWay(item.id, item.geopoint)}
                variant="success"
              >
                Start Route
              </ButtonStyled>
            ) : null}
          </ButtonGroubCont>
        ) : null}
        {getDeliveryMealType() === "dinner" ? (
          <ButtonGroubCont>
            {!item.delivered_dinner ? (
              <ButtonStyled
                onClick={() => setDelivered(item.id)}
                variant="success"
              >
                Delivered
              </ButtonStyled>
            ) : null}
            {!item.onway_dinner && !item.delivered_dinner ? (
              <ButtonStyled
                onClick={() => setOnWay(item.id, item.geopoint)}
                variant="success"
              >
                Start Route
              </ButtonStyled>
            ) : null}
          </ButtonGroubCont>
        ) : null}
      </Card>
    );
  };

  return (
    <div style={{ marginTop: 2 }}>
      {!isRouteAvailable ? (
        <div>
          {routeSelectionState === "route" ? (
            <div
              style={{
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                height: "87vh",
              }}
            >
              <Button onClick={RoutesDataApi} variant="success">
                Start Route
              </Button>
            </div>
          ) : null}
          {routeSelectionState === "driver" ? (
            <div
              style={{
                display: "flex",
                flexDirection: "column",
                justifyContent: "center",
                alignItems: "center",
                height: "87vh",
              }}
            >
              <DriverBtnList></DriverBtnList>
            </div>
          ) : null}
          {routeSelectionState === "best" ? (
            <div>
              <Container
                style={{
                  display: "flex",
                  height: 300,
                  background: "#253423",
                  marginBottom: 12,
                  justifyContent: "center",
                  alignItems: "center",
                }}
              >
                <Button onClick={BestRoute} variant="success">
                  Find Best Route
                </Button>
              </Container>
              {mealData
                ? mealData.map((item, index) => (
                    <MealCard key={index} item={item} index={index} />
                  ))
                : null}
            </div>
          ) : null}
        </div>
      ) : (
        <div>
          <Container
            style={{
              display: "flex",
              height: 300,
              background: "#253423",
              padding: 0,
              justifyContent: "center",
              alignItems: "center",
            }}
          >
            <div
              ref={refMap}
              style={{
                width: "100%",
                height: "100%",
              }}
            ></div>
          </Container>
          <div
            style={{
              display: "flex",
              flexDirection: "rows",
              margin: 12,
              color: "#a0a0a0",
            }}
          >
            <Button
              onClick={() => {
                setIsRouteCreated(false);
                setisRouteAvailable(false);
                setrouteSelectionState("route");
                setDriverMealList([]);
                setRouteData([]);
                setMealDeliveryData([]);
              }}
            >
              Reset
            </Button>
            <div style={{ marginLeft: 16 }}>
              <div>Total Distance</div>
              <div>{totalDistance}</div>
            </div>
            <div style={{ marginLeft: 16 }}>
              <div>Total Stops</div>
              <div>{totalStops}</div>
            </div>
          </div>
          {mealBestData
            ? mealBestData.map((item, index) => (
                <MealRouteCard key={index} item={item} index={index} />
              ))
            : null}
        </div>
      )}
    </div>
  );
};

export default Distribution;

const ButtonGroubCont = styled.div`
  display: flex;
  flex-direction: row;
  margin-left: 16px;
  margin-bottom: 24px;
`;

const ButtonStyled = styled(Button)`
  margin: 8px;
`;
